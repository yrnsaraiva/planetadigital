{% extends "main.html" %}
{% load static %}

{% block content %}

    {% include 'navbar.html' %}

    <div class="min-h-screen bg-[var(--bg)] text-white">
        <div class="max-w-6xl mx-auto px-4 py-10">
            <!-- Top Bar -->
            <div class="flex items-center justify-between mb-10">
                <a href="{% url 'shop:cart_detail' %}"
                   class="inline-flex items-center text-xs kicker text-white/60 hover:text-white transition">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Voltar ao carrinho
                </a>

                <div class="flex items-center gap-2">
                    <span class="text-xs text-white/50">Logado como</span>
                    <span
                            class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-white/10 border border-white/10 text-white/80">
                        {{ request.user.email }}
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <!-- LEFT: FORM -->
                <div class="lg:col-span-7">
                    <h1 class="text-3xl md:text-4xl font-bold text-white mb-6">Finalizar reserva</h1>

                    <form method="post" action="{% url 'shop:create_order' %}" id="checkoutForm" class="space-y-8">
                        {% csrf_token %}

                        <!-- DELIVERY (Ship / Pickup) -->
                        <section class="rounded-2xl p-5 border border-white/10 glass">
                            <h2 class="text-sm font-semibold tracking-wider text-white/80 uppercase mb-4">Entrega</h2>

                            <div class="space-y-3">
                                <label class="flex items-start gap-3 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                    <input type="radio" name="delivery_type" value="ship" class="mt-1 accent-white"
                                           checked>
                                    <div class="flex-1">
                                        <div class="font-semibold text-white">Entrega</div>
                                        <div class="text-sm text-white/60">Receba no seu endereço</div>
                                    </div>
                                </label>

                                <label class="flex items-start gap-3 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                    <input type="radio" name="delivery_type" value="pickup" class="mt-1 accent-white">
                                    <div class="flex-1">
                                        <div class="font-semibold text-white">Levantamento</div>
                                        <div class="text-sm text-white/60">Retire na loja / ponto de recolha</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Address block (only for ship) -->
                            <div id="shipAddressBlock" class="mt-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-white/80">Endereço de entrega</h3>
                                    {% if addresses %}
                                        <span class="text-xs text-white/50">Ou selecione um salvo</span>
                                    {% endif %}
                                </div>

                                {% if addresses %}
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                        {% for address in addresses %}
                                            <label class="cursor-pointer">
                                                <input type="radio" class="sr-only peer" name="selected_address"
                                                       value="{{ address.id }}"
                                                       {% if address.is_default %}checked{% endif %}>
                                                <div class="p-4 rounded-xl border border-white/10 bg-white/5 peer-checked:border-white peer-checked:ring-2 peer-checked:ring-white/10 hover:bg-white/10 transition">
                                                    <div class="flex items-start justify-between gap-3">
                                                        <div>
                                                            <div class="text-sm font-semibold text-white">
                                                                {{ address.get_full_name }}
                                                                {% if address.is_default %}
                                                                    <span class="ml-2 text-[10px] font-semibold px-2 py-0.5 rounded-full bg-white/10 border border-white/10 text-white/80">Principal</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="text-sm text-white/60 mt-1">
                                                                {{ address.street_address }}<br>
                                                                {{ address.city }}{% if address.postal_code %},
                                                                    {{ address.postal_code }}{% endif %}<br>
                                                                {{ address.country }}
                                                            </div>
                                                        </div>
                                                        <svg class="w-5 h-5 text-white opacity-0 peer-checked:opacity-100"
                                                             viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd"
                                                                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                                  clip-rule="evenodd"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                            </label>
                                        {% endfor %}
                                    </div>

                                    <div class="flex items-center gap-3 text-[10px] kicker text-white/50 mb-4">
                                        <div class="h-px flex-1 bg-white/10"></div>
                                        OU NOVO ENDEREÇO
                                        <div class="h-px flex-1 bg-white/10"></div>
                                    </div>
                                {% endif %}

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-semibold tracking-wider text-white/60 uppercase mb-2">Primeiro
                                            nome *</label>
                                        <input type="text" name="first_name"
                                               class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-white/10"
                                               placeholder="Yuran">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold tracking-wider text-white/60 uppercase mb-2">Apelido
                                            *</label>
                                        <input type="text" name="last_name"
                                               class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-white/10"
                                               placeholder="Saraiva">
                                    </div>

                                    <div class="md:col-span-2">
                                        <label class="block text-xs font-semibold tracking-wider text-white/60 uppercase mb-2">Morada
                                            *</label>
                                        <input type="text" name="street_address"
                                               class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-white/10"
                                               placeholder="Av. de Namaacha, ...">
                                    </div>

                                    <div>
                                        <label class="block text-xs font-semibold tracking-wider text-white/60 uppercase mb-2">Cidade
                                            *</label>
                                        <input type="text" name="city"
                                               class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-white/10"
                                               placeholder="Matola">
                                    </div>

                                    <div>
                                        <label class="block text-xs font-semibold tracking-wider text-white/60 uppercase mb-2">Código
                                            postal</label>
                                        <input type="text" name="postal_code"
                                               class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-white/10"
                                               placeholder="1100">
                                    </div>

                                </div>
                            </div>

                            <!-- Pickup block (only for pickup) -->
                            <div id="pickupBlock" class="mt-6 hidden">
                                <h3 class="text-sm font-semibold text-white/80 mb-3">Ponto de levantamento</h3>

                                <!-- envia sempre o mesmo ponto -->
                                <input type="hidden" name="pickup_location" value="pickup_default">

                                <div class="rounded-xl border border-white/10 bg-white/5 p-4">
                                    <div class="text-sm font-semibold text-white">Loja PLANETA</div>
                                    <p class="text-xs text-white/50 mt-1">Retirada na Coop.</p>
                                </div>
                            </div>

                        </section>

                        <!-- SHIPPING METHOD -->
                        <section class="rounded-2xl p-5 border border-white/10 glass" id="shippingSection">
                            <h2 class="text-sm font-semibold tracking-wider text-white/80 uppercase mb-4">Método de
                                envio</h2>

                            <div class="space-y-3">
                                {% if shipping_methods %}
                                    {% for m in shipping_methods %}
                                        <label class="flex items-center justify-between gap-4 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                            <div class="flex items-center gap-3">
                                                <input type="radio" name="shipping_method" value="{{ m.code }}"
                                                       class="accent-white"
                                                       {% if forloop.first %}checked{% endif %}>
                                                <div>
                                                    <div class="text-sm font-semibold text-white">{{ m.label }}</div>
                                                    {% if m.description %}
                                                        <div class="text-xs text-white/50">{{ m.description }}</div>{% endif %}
                                                </div>
                                            </div>
                                            <div class="text-sm font-semibold text-white">
                                                {% if m.price == 0 %}FREE{% else %}{{ m.price }} MZN{% endif %}
                                            </div>
                                        </label>
                                    {% endfor %}
                                {% else %}
                                    <label class="flex items-center justify-between gap-4 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="shipping_method" value="pickup_store"
                                                   class="accent-white" checked>
                                            <div>
                                                <div class="text-sm font-semibold text-white">Levantamento na loja</div>
                                                <div class="text-xs text-white/50">Sem custos</div>
                                            </div>
                                        </div>
                                        <div class="text-sm font-semibold text-white">FREE</div>
                                    </label>

                                    <label class="flex items-center justify-between gap-4 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="shipping_method" value="maputo"
                                                   class="accent-white">
                                            <div class="text-sm font-semibold text-white">Maputo</div>
                                        </div>
                                        <div class="text-sm font-semibold text-white">MZN 250.00</div>
                                    </label>

                                    <label class="flex items-center justify-between gap-4 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="shipping_method" value="local_delivery"
                                                   class="accent-white">
                                            <div class="text-sm font-semibold text-white">Local delivery</div>
                                        </div>
                                        <div class="text-sm font-semibold text-white">MZN 250.00</div>
                                    </label>

                                    <label class="flex items-center justify-between gap-4 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="shipping_method" value="matola"
                                                   class="accent-white">
                                            <div class="text-sm font-semibold text-white">Matola e arredores</div>
                                        </div>
                                        <div class="text-sm font-semibold text-white">MZN 400.00</div>
                                    </label>

                                    <label class="flex items-center justify-between gap-4 p-4 rounded-xl border border-white/10 cursor-pointer hover:bg-white/5 transition">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="shipping_method" value="other_provinces"
                                                   class="accent-white">
                                            <div class="text-sm font-semibold text-white">Outras províncias</div>
                                        </div>
                                        <div class="text-sm font-semibold text-white">MZN 1,000.00</div>
                                    </label>
                                {% endif %}
                            </div>
                        </section>

                        <!-- PAYMENT (COD ONLY) -->
                        <section class="rounded-2xl p-5 border border-white/10 glass">
                            <h2 class="text-sm font-semibold tracking-wider text-white/80 uppercase mb-3">
                                Pagamento
                            </h2>

                            <p class="text-sm text-white/60 mb-4">
                                O pagamento será efetuado no momento da entrega ou levantamento.
                            </p>

                            <div class="flex items-start gap-3 p-4 rounded-xl border border-white/20 bg-white/5">
                                <input type="hidden" name="payment_method" value="cod">

                                <svg class="w-5 h-5 text-white mt-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 4a2 2 0 00-2 2v2h16V6a2 2 0 00-2-2H4z"/>
                                    <path fill-rule="evenodd"
                                          d="M18 10H2v4a2 2 0 002 2h12a2 2 0 002-2v-4zm-4 3a1 1 0 11-2 0 1 1 0 012 0z"
                                          clip-rule="evenodd"/>
                                </svg>

                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-white">
                                        Cash on Delivery (COD)
                                    </div>
                                    <div class="text-xs text-white/60 mt-1">
                                        Pagamento em numerário, POS ou M-Pesa no ato da entrega
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 text-xs text-white/50">
                                Não é necessário pagamento online. O valor total será cobrado quando receber o produto.
                            </div>
                        </section>

                        <!-- SUBMIT -->
                        <div class="pt-2">
                            <button
                                    type="submit"
                                    id="submitBtn"
                                    class="w-full rounded-2xl bg-white text-black font-bold py-4 hover:bg-white/90 transition disabled:opacity-60 disabled:cursor-not-allowed"
                            >
                                Finalizar pedido
                            </button>

                            <p class="text-xs text-white/50 mt-3">
                                Ao finalizar, você concorda com os termos e condições e política de privacidade.
                            </p>
                        </div>
                    </form>
                </div>

                <!-- RIGHT: SUMMARY -->
                <aside class="lg:col-span-5">
                    <div class="lg:sticky lg:top-6 space-y-4">
                        <div class="rounded-2xl p-5 border border-white/10 glass">
                            <h2 class="text-sm font-semibold tracking-wider text-white/80 uppercase mb-4">Resumo</h2>

                            <div class="space-y-4">
                                {% for item in cart_items %}
                                    <div class="flex items-start gap-4">
                                        <div class="w-14 h-14 rounded-xl border border-white/10 overflow-hidden bg-white/5 flex items-center justify-center">
                                            {% with item.variant.product.images.first as product_image %}
                                                {% if product_image %}
                                                    <img src="{{ product_image.image.url }}"
                                                         alt="{{ item.variant.product.name }}"
                                                         class="w-full h-full object-cover">
                                                {% else %}
                                                    <svg class="w-7 h-7 text-white/25" viewBox="0 0 20 20"
                                                         fill="currentColor">
                                                        <path fill-rule="evenodd"
                                                              d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                                                              clip-rule="evenodd"></path>
                                                    </svg>
                                                {% endif %}
                                            {% endwith %}
                                        </div>

                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-start justify-between gap-3">
                                                <div class="min-w-0">
                                                    <p class="text-sm font-semibold text-white truncate">{{ item.variant.product.name }}</p>
                                                    <p class="text-xs text-white/50 mt-1">
                                                        Qtd: {{ item.quantity }}
                                                        {% if item.variant.size %} · {{ item.variant.size }}{% endif %}
                                                    </p>
                                                </div>
                                                <div class="text-sm font-semibold text-white whitespace-nowrap">
                                                    {{ item.get_total_price }} MZN
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="h-px bg-white/10 my-5"></div>

                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between text-white/70">
                                    <span>Subtotal</span>
                                    <span class="font-semibold text-white">{{ total_price }} MZN</span>
                                </div>

                                <div class="flex items-center justify-between text-white/70">
                                    <span>Envio</span>
                                    <span class="font-semibold text-white" id="shippingLabel">—</span>
                                </div>

                                <div class="flex items-center justify-between text-white/70">
                                    <span>Desconto</span>
                                    <span class="font-semibold text-white">0 MZN</span>
                                </div>

                                <div class="h-px bg-white/10 my-3"></div>

                                <div class="flex items-center justify-between text-white">
                                    <span class="text-base font-bold">Total</span>
                                    <span class="text-base font-bold" id="totalLabel">{{ total_price }} MZN</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const shipAddressBlock = document.getElementById('shipAddressBlock');
            const pickupBlock = document.getElementById('pickupBlock');
            const shippingSection = document.getElementById('shippingSection');
            const billingBlock = document.getElementById('billingBlock');

            const shippingLabel = document.getElementById('shippingLabel');
            const totalLabel = document.getElementById('totalLabel');

            // Base total (string) -> number
            const baseTotalStr = "{{ total_price|default:'0' }}";
            const baseTotal = Number(String(baseTotalStr).replace(/[^\d.]/g, "")) || 0;

            function setDeliveryUI() {
                const type = document.querySelector('input[name="delivery_type"]:checked')?.value || 'ship';


                if (type === 'pickup') {
                    document.querySelectorAll('input[name="shipping_method"]').forEach(r => r.checked = false)
                    shipAddressBlock.classList.add('hidden');
                    pickupBlock.classList.remove('hidden');
                    shippingSection.classList.add('hidden');

                    shippingLabel.textContent = "FREE";
                    totalLabel.textContent = `${baseTotal.toLocaleString('pt-PT')} MZN`;
                } else {
                    shipAddressBlock.classList.remove('hidden');
                    pickupBlock.classList.add('hidden');
                    shippingSection.classList.remove('hidden');
                    updateShippingTotal();
                }
            }

            function updateShippingTotal() {
                const selected = document.querySelector('input[name="shipping_method"]:checked');
                if (!selected) {
                    shippingLabel.textContent = "—";
                    totalLabel.textContent = `${baseTotal.toLocaleString('pt-PT')} MZN`;
                    return;
                }

                const card = selected.closest('label');
                let priceText = card?.querySelector('div.text-sm.font-semibold, div.text-sm.font-semibold.text-gray-900, div.text-sm.font-semibold.text-white')?.textContent || "";
                priceText = priceText.trim().toUpperCase();

                let shipCost = 0;
                if (priceText.includes("FREE")) {
                    shipCost = 0;
                    shippingLabel.textContent = "FREE";
                } else {
                    const num = Number(priceText.replace(/[^\d.]/g, "")) || 0;
                    shipCost = num;
                    shippingLabel.textContent = `MZN ${shipCost.toFixed(2)}`;
                }

                const grand = baseTotal + shipCost;
                totalLabel.textContent = `${grand.toLocaleString('pt-PT')} MZN`;
            }

            function setBillingUI() {
                if (!billingBlock) return;
                const same = document.querySelector('input[name="billing_same_as_shipping"]:checked')?.value || 'yes';
                if (same === 'no') billingBlock.classList.remove('hidden');
                else billingBlock.classList.add('hidden');
            }

            document.querySelectorAll('input[name="delivery_type"]').forEach(r => r.addEventListener('change', setDeliveryUI));
            document.querySelectorAll('input[name="shipping_method"]').forEach(r => r.addEventListener('change', updateShippingTotal));
            document.querySelectorAll('input[name="billing_same_as_shipping"]').forEach(r => r.addEventListener('change', setBillingUI));

            const form = document.getElementById('checkoutForm');
            const submitBtn = document.getElementById('submitBtn');

            form.addEventListener('submit', function () {
                submitBtn.disabled = true;
                submitBtn.textContent = "Processando...";
            });

            setDeliveryUI();
            setBillingUI();
            updateShippingTotal();
        })();
    </script>

    <script src="https://unpkg.com/kursor"></script>
    <script>
        new kursor({
            type: 1,
            removeDefaultCursor: true,
            color: '#fff'
        })
    </script>

{% endblock %}
