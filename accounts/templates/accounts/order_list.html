{% extends "main.html" %}
{% load static %}

{% block content %}
    {% include "navbar.html" %}

    <main class="max-w-6xl mx-auto px-4 pt-10 pb-16">

        <!-- BREADCRUMB -->
        <nav class="text-[10px] kicker text-white/45 mb-6">
            <a href="#" class="hover:text-white transition">Conta</a>
            <span class="mx-2">/</span>
            <span class="text-white/70">Meus Pedidos</span>
        </nav>

        <!-- HEADER -->
        <div class="mb-10">
            <div class="font-monoish kicker text-[10px] text-[var(--accent)]/80 uppercase tracking-wider">
                Conta
            </div>
            <h1 class="font-display text-4xl md:text-5xl uppercase leading-[0.9] mt-2">
                Meus Pedidos
            </h1>
            <p class="mt-4 text-white/60 max-w-2xl">
                Acompanhe o hist√≥rico dos seus pedidos na PLANETA.
            </p>
        </div>

        {% if orders %}
            <!-- FILTROS -->
            <div class="mb-8 flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] kicker text-white/60">Filtrar:</span>
                    <select id="statusFilter"
                            class="rounded-full bg-black/40 border border-white/15 px-4 py-2 text-xs text-white/90 outline-none focus:border-white/30">
                        <option value="all">Todos os pedidos</option>
                        <option value="pending">Pendentes</option>
                        <option value="confirmed">Confirmados</option>
                        <option value="cancelled">Cancelados</option>
                    </select>
                </div>

                <div class="flex-1"></div>

                <div class="text-[10px] kicker text-white/45">
                    {{ orders|length }} pedido{{ orders|length|pluralize }}
                </div>
            </div>

            <!-- LISTA DE PEDIDOS -->
            <div class="space-y-6" id="ordersList">
                {% for order in orders %}
                    <div class="rounded-3xl border border-white/10 bg-black/20 overflow-hidden" data-status="{{ order.status }}">
                        <!-- HEADER DO PEDIDO -->
                        <div class="p-6 border-b border-white/10 flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <div class="flex items-center gap-3">
                                    <div class="font-display uppercase text-xl">Pedido #{{ order.order_number }}</div>
                                    {% if order.status == "pending" %}
                                        <span class="rounded-full px-3 py-1 text-[10px] font-monoish bg-yellow-500/20 text-yellow-300 border border-yellow-500/30">
                                            Pendente
                                        </span>
                                    {% elif order.status == "confirmed" %}
                                        <span class="rounded-full px-3 py-1 text-[10px] font-monoish bg-green-500/20 text-green-300 border border-green-500/30">
                                            Confirmado
                                        </span>
                                    {% elif order.status == "cancelled" %}
                                        <span class="rounded-full px-3 py-1 text-[10px] font-monoish bg-red-500/20 text-red-300 border border-red-500/30">
                                            Cancelado
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="mt-2 text-sm text-white/60">
                                    Realizado em {{ order.created_at|date:"d/m/Y H:i" }}
                                    {% if order.placed_at %}
                                        ‚Ä¢ Confirmado em {{ order.placed_at|date:"d/m/Y H:i" }}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-right">
                                <div class="font-display text-2xl">{{ order.total_amount|floatformat:2 }} MZN</div>
                                <div class="mt-1 text-sm text-white/60">
                                    {% if order.fulfillment_method == "delivery" %}
                                        üöö Entrega
                                    {% else %}
                                        üè¢ Levantamento
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- ITENS DO PEDIDO -->
                        <div class="p-6">
                            <div class="text-[10px] kicker text-white/60 mb-4">Itens</div>
                            <div class="space-y-4">
                                {% for item in order.items.all %}
                                    <div class="flex items-center gap-4 p-4 rounded-xl border border-white/5 bg-black/30">
                                        <!-- Imagem do produto -->
                                        <div class="w-16 h-16 rounded-lg overflow-hidden border border-white/10">
                                            {% if item.product_variant.product.images.all %}
                                                <img src="{{ item.product_variant.product.images.first.image.url }}"
                                                     alt="{{ item.product_variant.product.name }}"
                                                     class="w-full h-full object-cover">
                                            {% else %}
                                                <div class="w-full h-full bg-gradient-to-br from-black/30 to-[var(--accent)]/20 flex items-center justify-center">
                                                    <span class="text-xs text-white/40">IMG</span>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Informa√ß√µes do item -->
                                        <div class="flex-1">
                                            <div class="font-display uppercase">{{ item.product_variant.product.name }}</div>
                                            <div class="text-sm text-white/60 mt-1">
                                                Tamanho: {{ item.product_variant.get_size_display }}
                                                ‚Ä¢ Quantidade: {{ item.quantity }}
                                            </div>
                                        </div>

                                        <!-- Pre√ßo -->
                                        <div class="text-right">
                                            <div class="text-lg font-medium">{{ item.total_price|floatformat:2 }} MZN</div>
                                            <div class="text-sm text-white/60">{{ item.unit_price|floatformat:2 }} MZN/un</div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- RESUMO -->
                        <div class="p-6 border-t border-white/10 bg-black/30">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Informa√ß√µes do cliente -->
                                <div>
                                    <div class="text-[10px] kicker text-white/60 mb-2">Cliente</div>
                                    <div class="text-sm">
                                        <div class="font-medium">{{ order.customer_name }}</div>
                                        <div class="text-white/60">{{ order.customer_email }}</div>
                                        {% if order.customer_phone %}
                                            <div class="text-white/60">{{ order.customer_phone }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Entrega/Levantamento -->
                                <div>
                                    <div class="text-[10px] kicker text-white/60 mb-2">
                                        {% if order.fulfillment_method == "delivery" %}
                                            Entrega
                                        {% else %}
                                            Levantamento
                                        {% endif %}
                                    </div>
                                    <div class="text-sm">
                                        {% if order.fulfillment_method == "delivery" and order.shipping_address %}
                                            <div class="text-white/80">{{ order.shipping_address|linebreaksbr }}</div>
                                        {% elif order.fulfillment_method == "pickup" %}
                                            <div class="text-white/80">Triunfo, Maputo</div>
                                            <div class="text-white/60 text-xs mt-1">Pagamento no levantamento</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Total -->
                                <div class="text-right">
                                    <div class="text-[10px] kicker text-white/60 mb-2">Resumo</div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-white/60">Subtotal:</span>
                                            <span>{{ order.subtotal_amount|floatformat:2 }} MZN</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-white/60">Entrega:</span>
                                            <span>{{ order.delivery_fee|floatformat:2 }} MZN</span>
                                        </div>
                                        <div class="flex justify-between text-lg font-bold mt-2 pt-2 border-t border-white/10">
                                            <span>Total:</span>
                                            <span>{{ order.total_amount|floatformat:2 }} MZN</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- A√á√ïES -->
                            {% if order.status == "pending" %}
                                <div class="mt-6 pt-6 border-t border-white/10 flex flex-wrap gap-3">
                                    <button onclick="confirmOrder('{{ order.order_number }}')"
                                            class="rounded-full px-6 py-2 bg-white text-black font-bold hover:bg-white/90 transition text-sm">
                                        Confirmar Recep√ß√£o
                                    </button>
                                    <button onclick="cancelOrder('{{ order.order_number }}')"
                                            class="rounded-full px-6 py-2 border border-red-500/30 text-red-400 hover:bg-red-500/10 transition text-sm">
                                        Cancelar Pedido
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- PAGINA√á√ÉO -->
            {% if is_paginated %}
                <div class="mt-10 flex justify-center">
                    <div class="flex items-center gap-2">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}"
                               class="rounded-full px-4 py-2 text-sm border border-white/15 hover:border-white/30 transition">
                                ‚Üê Anterior
                            </a>
                        {% endif %}

                        <span class="text-sm text-white/60 px-4">
                            P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}"
                               class="rounded-full px-4 py-2 text-sm border border-white/15 hover:border-white/30 transition">
                                Pr√≥xima ‚Üí
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

        {% else %}
            <!-- SEM PEDIDOS -->
            <div class="rounded-3xl border border-white/10 bg-black/20 p-12 text-center">
                <div class="text-white/40 text-6xl mb-4">üì¶</div>
                <h3 class="font-display text-2xl uppercase mb-2">Nenhum pedido encontrado</h3>
                <p class="text-white/50 text-sm max-w-md mx-auto mb-6">
                    Voc√™ ainda n√£o fez nenhum pedido na PLANETA.
                </p>
                <a href="{% url 'shop:product_list' %}"
                   class="inline-flex items-center gap-2 rounded-full px-6 py-3 bg-white text-black font-bold hover:bg-white/90 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                    </svg>
                    Ver Produtos
                </a>
            </div>
        {% endif %}

    </main>

    {% include "footer.html" %}

    <script>
        // Filtro por status
        document.getElementById('statusFilter')?.addEventListener('change', function(e) {
            const status = e.target.value;
            const orders = document.querySelectorAll('[data-status]');

            orders.forEach(order => {
                if (status === 'all' || order.getAttribute('data-status') === status) {
                    order.style.display = 'block';
                } else {
                    order.style.display = 'none';
                }
            });
        });

        // Confirmar recep√ß√£o do pedido
        function confirmOrder(orderNumber) {
            if (confirm(`Confirmar que recebeu o pedido ${orderNumber}?`)) {
                fetch(`/accounts/orders/${orderNumber}/confirm/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erro ao confirmar pedido: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erro ao confirmar pedido');
                });
            }
        }

        // Cancelar pedido
        function cancelOrder(orderNumber) {
            if (confirm(`Tem certeza que deseja cancelar o pedido ${orderNumber}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                fetch(`/accounts/orders/${orderNumber}/cancel/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erro ao cancelar pedido: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erro ao cancelar pedido');
                });
            }
        }

        // Ordenar pedidos por data (mais recente primeiro)
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se h√° pedidos pendentes para destacar
            const pendingOrders = document.querySelectorAll('[data-status="pending"]');
            if (pendingOrders.length > 0) {
                // Mover pedidos pendentes para o topo
                const ordersList = document.getElementById('ordersList');
                pendingOrders.forEach(order => {
                    ordersList.prepend(order);
                });

                // Atualizar contador
                const counter = document.querySelector('.text-\\[10px\\].kicker.text-white\\/45');
                if (counter) {
                    counter.innerHTML = `{{ orders|length }} pedido{{ orders|length|pluralize }} ‚Ä¢ ${pendingOrders.length} pendente${pendingOrders.length !== 1 ? 's' : ''}`;
                }
            }
        });
    </script>

    <style>
        /* Anima√ß√µes para os pedidos */
        [data-status] {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.4s ease forwards;
        }

        [data-status="pending"] {
            animation-delay: 0.1s;
            border-left: 4px solid rgba(245, 158, 11, 0.3);
        }

        [data-status="confirmed"] {
            animation-delay: 0.2s;
            border-left: 4px solid rgba(34, 197, 94, 0.3);
        }

        [data-status="cancelled"] {
            animation-delay: 0.3s;
            border-left: 4px solid rgba(239, 68, 68, 0.3);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Efeito hover nos cards de pedido */
        .rounded-3xl.border-white\\/10 {
            transition: all 0.2s ease;
        }

        .rounded-3xl.border-white\\/10:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .text-4xl {
                font-size: 2rem;
            }

            .p-6 {
                padding: 1.25rem;
            }

            .grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
    </style>
{% endblock %}